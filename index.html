<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Tickets ‚Äî Automatyczna obs≈Çuga klient√≥w</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#071426;--card:#0b1220;--muted:#9aa4b2;--accent:#6ee7b7}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Arial;margin:0;background:linear-gradient(180deg,#041020,#071426);color:#e6eef6}
    .wrap{max-width:980px;margin:28px auto;padding:22px}
    .card{background:var(--card);padding:20px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    h1{margin:0 0 8px;font-size:26px}
    p.lead{color:var(--muted);margin:0 0 14px}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:20px}
    .features{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .chip{background:rgba(255,255,255,0.03);padding:8px 10px;border-radius:8px;color:var(--muted);font-size:13px}
    .btn{display:inline-block;padding:10px 14px;border-radius:10px;background:var(--accent);color:#022;font-weight:700;text-decoration:none}
    /* form */
    form.fieldset{display:block}
    label{display:block;color:var(--muted);font-size:13px;margin-top:8px}
    input[type=text], input[type=email], textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    textarea{min-height:90px;resize:vertical}
    .submit-row{margin-top:12px}
    .small{font-size:13px;color:var(--muted)}
    .pkg{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:10px}
    .demo{background:#071826;padding:12px;border-radius:10px;margin-top:12px}
    .messages{max-height:200px;overflow:auto;display:flex;flex-direction:column;gap:8px;margin-bottom:8px}
    .msg{padding:10px;border-radius:8px;background:rgba(255,255,255,0.03)}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header style="display:flex;align-items:center;justify-content:space-between;">
        <div>
          <div style="font-weight:800">AI Tickets</div>
          <div class="small">Automatyczna obs≈Çuga klient√≥w ‚Ä¢ 24/7</div>
        </div>
        <a class="btn" href="mailto:aiticketspro@gmail.com?subject=Analiza%20AI%20Tickets">Um√≥w bezp≈ÇatnƒÖ analizƒô</a>
      </header>

      <main style="margin-top:18px" class="grid">
        <section>
          <h1>Automatyczna obs≈Çuga klient√≥w ‚Äî demo</h1>
          <p class="lead">Poka≈ºƒô Ci, jak AI automatyzuje odpowiedzi. Wype≈Çnij formularz, a Twoje zg≈Çoszenie trafi prosto na e-mail: <strong>aiticketspro@gmail.com</strong>.</p>

          <div class="pkg">
            <strong>Pakiety</strong>
            <div style="display:flex;gap:8px;margin-top:8px">
              <div style="flex:1"><strong>Basic</strong><div class="small">Jednorazowe wdro≈ºenie + szablony</div></div>
              <div style="flex:1"><strong>Standard</strong><div class="small">Automatyczne odpowiedzi + integracja</div></div>
              <div style="flex:1"><strong>Pro</strong><div class="small">Pe≈Çne wdro≈ºenie + raporty</div></div>
            </div>
          </div>

          <h3 style="margin-top:14px">Formularz zg≈Çoszeniowy</h3>

          <!-- FORM: Formsubmit.co action wysy≈Ça email na aiticketspro@gmail.com -->
          <form id="leadForm" action="https://formsubmit.co/aiticketspro@gmail.com" method="POST" class="fieldset">
            <!-- hidden fields for formsubmit -->
            <input type="hidden" name="_subject" value="Nowy lead z AI Tickets">
            <input type="hidden" name="_captcha" value="false">
            <!-- redirect back to same page with query ?sent=1 -->
            <input type="hidden" name="_next" value="https://kamil1402.github.io/aitickets-pro/?sent=1">

            <label for="company">Nazwa firmy</label>
            <input id="company" name="Firma" type="text" placeholder="Np. Salon Beauty XYZ" required>

            <label for="contact">E-mail kontaktowy</label>
            <input id="contact" name="Email" type="email" placeholder="kontakt@firma.pl" required>

            <label for="phone">Telefon (opcjonalnie)</label>
            <input id="phone" name="Telefon" type="text" placeholder="np. +48 600 000 000">

            <label for="channel">Gdzie klienci piszƒÖ?</label>
            <input id="channel" name="Kana≈Ç" type="text" placeholder="Instagram / Messenger / e-mail / inne">

            <label for="msg">Kr√≥tko ‚Äî na czym polega problem (2‚Äì3 zdania)</label>
            <textarea id="msg" name="Wiadomo≈õƒá" placeholder="Np. du≈ºa liczba pyta≈Ñ o zwroty" required></textarea>

            <div class="submit-row">
              <button type="submit" class="btn">Wy≈õlij zg≈Çoszenie</button>
            </div>
          </form>

          <div id="thanks" class="small" style="margin-top:10px; display:none">
            Dziƒôkujemy! Twoje zg≈Çoszenie zosta≈Ço wys≈Çane ‚Äî sprawdzimy je i skontaktujemy siƒô na podany e-mail.
          </div>

          <p class="small" style="margin-top:8px">Uwaga: pierwsze wys≈Çanie wymaga potwierdzenia adresu e-mail przez Formsubmit (dostaniesz od nich mail z linkiem; kliknij go, aby aktywowaƒá odbieranie wiadomo≈õci).</p>

        </section>

        <aside>
          <div class="pkg">
            <strong>Demo AI Tickets</strong>
            <p class="small">Wklej przyk≈ÇadowƒÖ wiadomo≈õƒá klienta i zobacz jak system kategoryzuje i odpowiada.</p>

            <div class="demo">
              <div class="messages" id="messages">
                <div class="msg small">Przyk≈Çady: "Nie mogƒô siƒô zalogowaƒá", "Chcia≈Çbym zwr√≥ciƒá buty", "Kiedy moja paczka?"</div>
              </div>

              <input id="inputTxt" placeholder="Wklej tre≈õƒá zg≈Çoszenia klienta..." />
              <div style="display:flex;gap:8px;margin-top:8px">
                <button id="processBtn" class="btn">Przetw√≥rz</button>
              </div>
            </div>

            <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)" />

            <div>
              <strong>Gotowe skrypty DM (szybkie)</strong>
              <div class="small" style="margin-top:8px">
                <p><strong>Wiadomo≈õƒá pierwsza (DM):</strong><br>
                Cze≈õƒá! üëã Pomagam firmom automatyzowaƒá odpowiedzi na wiadomo≈õci klient√≥w (AI). Chcesz 7 dni test√≥w za darmo?</p>

                <p><strong>Follow-up (po 2 dniach):</strong><br>
                Hej ‚Äî czy mia≈Çe≈õ chwilƒô, ≈ºeby sprawdziƒá demo? Mogƒô zrobiƒá szybkƒÖ analizƒô Twoich wiadomo≈õci.</p>
              </div>
            </div>

          </div>
        </aside>

      </main>

      <footer style="margin-top:18px" class="small">
        ¬© AI Tickets ‚Äî Strona demo. Zmie≈Ñ dane kontaktowe przed publikacjƒÖ.
      </footer>
    </div>
  </div>

<script>
  // demo classifier + reply (lokalna symulacja)
  const messagesEl = document.getElementById('messages');
  const input = document.getElementById('inputTxt');
  const proc = document.getElementById('processBtn');
  function appendMsg(text, cls=''){ const d = document.createElement('div'); d.className = 'msg ' + (cls||''); d.textContent = text; messagesEl.appendChild(d); messagesEl.scrollTop = messagesEl.scrollHeight; }
  function classify(text){
    const t = text.toLowerCase();
    if(t.includes('log')||t.includes('has≈Ç')||t.includes('zalog')) return {cat:'Logowanie/Konto', auto:true};
    if(t.includes('zwrot')||t.includes('zwr√≥ciƒá')||t.includes('zwroty')) return {cat:'Zwroty/Reklamacje', auto:true};
    if(t.includes('zap≈Çaci')||t.includes('p≈Çat')||t.includes('kod')) return {cat:'P≈Çatno≈õci', auto:false};
    if(t.includes('paczka')||t.includes('dostaw')||t.includes('wysy≈Çk')) return {cat:'Dostawa', auto:true};
    return {cat:'Inne', auto:false};
  }
  function generateReply(text){
    const c = classify(text);
    let tone='neutralny';
    if(/[!]{2,}|nie|proszƒô|pilne/i.test(text)) tone='zdenerwowany';
    let reply='';
    switch(c.cat){
      case 'Logowanie/Konto': reply = 'Proszƒô skorzystaƒá z linku do resetu has≈Ça: [link resetu].'; break;
      case 'Zwroty/Reklamacje': reply = 'Proszƒô wype≈Çniƒá formularz zwrotu: [link zwrotu].'; break;
      case 'P≈Çatno≈õci': reply = 'Sprawdzimy status p≈Çatno≈õci i wr√≥cimy w ciƒÖgu 24h.'; break;
      case 'Dostawa': reply = 'Sprawdzimy status przesy≈Çki ‚Äî podaj numer zam√≥wienia.'; break;
      default: reply = 'Proszƒô podaƒá numer zam√≥wienia i opis problemu.'; break;
    }
    return {cat:c.cat, tone: tone, reply: reply, auto: c.auto};
  }
  proc.addEventListener('click', ()=>{
    const txt = input.value.trim(); if(!txt) return;
    appendMsg(txt,'client');
    const out = generateReply(txt);
    setTimeout(()=>{ appendMsg('Kategoria: '+out.cat+' ‚Ä¢ Ton: '+out.tone+'\\nOdpowied≈∫: '+out.reply); },400);
  });

  // after form submit redirect: show thank you text if ?sent=1
  (function(){
    const params = new URLSearchParams(location.search);
    if(params.get('sent')==='1'){ document.getElementById('thanks').style.display='block'; }
  })();
</script>
</body>
</html> <form action="https://formsubmit.co/aiticketspro@gmail.com" method="POST">
  <!-- Wy≈ÇƒÖcz Captchƒô -->
  <input type="hidden" name="_captcha" value="false">
  
  <!-- Przekierowanie po wys≈Çaniu -->
  <input type="hidden" name="_next" value="https://kamil1402.github.io/aitickets-pro/dziekuje.html">

  <label for="name">Imiƒô:</label>
  <input type="text" id="name" name="name" required>

  <label for="email">Email:</label>
  <input type="email" id="email" name="email" required>

  <label for="message">Wiadomo≈õƒá:</label>
  <textarea id="message" name="message" rows="5" required></textarea>

  <button type="submit">Wy≈õlij</button>
</form>
<form action="https://formsubmit.co/aiticketspro@gmail.com" method="POST">
  <!-- Wy≈ÇƒÖcz Captchƒô -->
  <input type="hidden" name="_captcha" value="false">
  
  <!-- Przekierowanie po wys≈Çaniu -->
  <input type="hidden" name="_next" value="https://kamil1402.github.io/aitickets-pro/dziekuje.html">

  <h2>Formularz zg≈Çoszeniowy AI Tickets (B2B)</h2>

  <label for="company">Nazwa firmy:</label>
  <input type="text" id="company" name="company" placeholder="Np. ACME Sp. z o.o." required>

  <label for="name">Imiƒô i nazwisko kontaktowe:</label>
  <input type="text" id="name" name="name" placeholder="Np. Jan Kowalski" required>

  <label for="email">Email kontaktowy:</label>
  <input type="email" id="email" name="email" placeholder="Np. jan.kowalski@acme.com" required>

  <label for="phone">Telefon kontaktowy:</label>
  <input type="tel" id="phone" name="phone" placeholder="Np. +48 600 123 456" required>

  <label for="subject">Temat zg≈Çoszenia:</label>
  <input type="text" id="subject" name="subject" placeholder="Np. Problem z integracjƒÖ API" required>

  <label for="message">Opis problemu / zg≈Çoszenia:</label>
  <textarea id="message" name="message" rows="5" placeholder="Opisz problem szczeg√≥≈Çowo" required></textarea>

  <label for="priority">Priorytet zg≈Çoszenia:</label>
  <select id="priority" name="priority" required>
    <option value="">Wybierz priorytet</option>
    <option value="niski">Niski</option>
    <option value="≈õredni">≈öredni</option>
    <option value="wysoki">Wysoki</option>
  </select>

  <label for="category">Kategoria zg≈Çoszenia:</label>
  <select id="category" name="category" required>
    <option value="">Wybierz kategoriƒô</option>
    <option value="techniczne">Techniczne</option>
    <option value="integracje">Integracje</option>
    <option value="inne">Inne</option>
  </select>

  <button type="submit">Wy≈õlij zg≈Çoszenie</button>
</form>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const urlField = document.createElement("input");
    urlField.type = "hidden";
    urlField.name = "page_url";
    urlField.value = window.location.href; // pe≈Çny adres aktualnej strony
    document.querySelector("form").appendChild(urlField);
  });
</script>
<!-- Skrypt dodajƒÖcy pe≈Çny URL strony do maila -->
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const urlField = document.createElement("input");
    urlField.type = "hidden";
    urlField.name = "page_url"; // nazwa pola, kt√≥re pojawi siƒô w mailu
    urlField.value = window.location.href; // pe≈Çny adres aktualnej strony
    document.querySelector("form").appendChild(urlField);
  });
</script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const urlField = document.createElement("input");
    urlField.type = "hidden";
    urlField.name = "page_url";
    urlField.value = window.location.href; // pe≈Çny aktualny URL
    document.querySelector("form").appendChild(urlField);
  });
</script>
<form action="https://formsubmit.co/aiticketspro@gmail.com" method="POST" style="max-width:600px;margin:0 auto;padding:20px;background:#f9f9f9;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.1);font-family:sans-serif;">
  <input type="hidden" name="_captcha" value="false">
  <input type="hidden" name="_next" value="https://kamil1402.github.io/aitickets-pro/dziekuje.html">

  <h2 style="text-align:center;color:#333;margin-bottom:20px;">Formularz kontaktowy</h2>

  <label for="name" style="display:block;margin-bottom:5px;color:#555;">Imiƒô i nazwisko:</label>
  <input type="text" id="name" name="name" placeholder="Np. Jan Kowalski" required style="width:100%;padding:10px;margin-bottom:15px;border:1px solid #ccc;border-radius:6px;">

  <label for="email" style="display:block;margin-bottom:5px;color:#555;">Email:</label>
  <input type="email" id="email" name="email" placeholder="Np. jan.kowalski@gmail.com" required style="width:100%;padding:10px;margin-bottom:15px;border:1px solid #ccc;border-radius:6px;">

  <label for="message" style="display:block;margin-bottom:5px;color:#555;">Wiadomo≈õƒá:</label>
  <textarea id="message" name="message" rows="5" placeholder="Opisz sw√≥j problem" required style="width:100%;padding:10px;margin-bottom:15px;border:1px solid #ccc;border-radius:6px;"></textarea>

  <button type="submit" style="width:100%;padding:12px;background:#4CAF50;color:white;border:none;border-radius:8px;font-size:16px;cursor:pointer;transition:background 0.3s;">Wy≈õlij</button>
  <button type="reset" style="width:100%;padding:12px;margin-top:10px;background:#f44336;color:white;border:none;border-radius:8px;font-size:16px;cursor:pointer;transition:background 0.3s;">Wyczy≈õƒá</button>

  <!-- Dodanie ukrytego pola URL strony -->
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const urlField = document.createElement("input");
      urlField.type = "hidden";
      urlField.name = "page_url";
      urlField.value = window.location.href;
      document.querySelector("form").appendChild(urlField);
    });
  </script>
</form>
<form action="https://formsubmit.co/aiticketspro@gmail.com" method="POST" style="max-width:600px;margin:0 auto;padding:20px;background:#f9f9f9;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.1);font-family:sans-serif;">
  <input type="hidden" name="_captcha" value="false">
  <input type="hidden" name="_next" value="https://kamil1402.github.io/aitickets-pro/dziekuje.html">

  <h2 style="text-align:center;color:#333;margin-bottom:20px;">Formularz zg≈Çoszeniowy AI Tickets (B2B)</h2>

  <label for="company" style="display:block;margin-bottom:5px;color:#555;">Nazwa firmy:</label>
  <input type="text" id="company" name="company" placeholder="Np. ACME Sp. z o.o." required style="width:100%;padding:10px;margin-bottom:15px;border:1px solid #ccc;border-radius:6px;">

  <label for="name" style="display:block;margin-bottom:5px;color:#555;">Imiƒô i nazwisko kontaktowe:</label>
  <input type="text" id="name" name="name" placeholder="Np. Jan Kowalski" required style="width:100%;padding:10px;margin-bottom:15px;border:1px solid #ccc;border-radius:6px;">

  <label for="email" style="display:block;margin-bottom:5px;color:#555;">Email kontaktowy:</label>
  <input type="email" id="email" name="email" placeholder="Np. jan.kowalski@acme.com" required style="width:100%;padding:10px;margin-bottom:15px;border:1px solid #ccc;border-radius:6px;">

  <label for="phone" style="display:block;margin-bottom:5px;color:#555;">Telefon kontaktowy:</label>
  <input type="tel" id="phone" name="phone" placeholder="Np. +48 600 123 456" required style="width:100%;padding:10px;margin-bottom:15px;border:1px solid #ccc;border-radius:6px;">

  <label for="subject" style="display:block;margin-bottom:5px;color:#555;">Temat zg≈Çoszenia:</label>
  <input type="text" id="subject" name="subject" placeholder="Np. Problem z integracjƒÖ API" required style="width:100%;padding:10px;margin-bottom:15px;border:1px solid #ccc;border-radius:6px;">

  <label for="message" style="display:block;margin-bottom:5px;color:#555;">Opis problemu / zg≈Çoszenia:</label>
  <textarea id="message" name="message" rows="5" placeholder="Opisz problem szczeg√≥≈Çowo" required style="width:100%;padding:10px;margin-bottom:15px;border:1px solid #ccc;border-radius:6px;"></textarea>

  <label for="priority" style="display:block;margin-bottom:5px;color:#555;">Priorytet zg≈Çoszenia:</label>
  <select id="priority" name="priority" required style="width:100%;padding:10px;margin-bottom:15px;border:1px solid #ccc;border-radius:6px;">
    <option value="">Wybierz priorytet</option>
    <option value="niski">Niski</option>
    <option value="≈õredni">≈öredni</option>
    <option value="wysoki">Wysoki</option>
  </select>

  <label for="category" style="display:block;margin-bottom:5px;color:#555;">Kategoria zg≈Çoszenia:</label>
  <select id="category" name="category" required style="width:100%;padding:10px;margin-bottom:20px;border:1px solid #ccc;border-radius:6px;">
    <option value="">Wybierz kategoriƒô</option>
    <option value="techniczne">Techniczne</option>
    <option value="integracje">Integracje</option>
    <option value="inne">Inne</option>
  </select>

  <button type="submit" style="width:100%;padding:12px;background:#4CAF50;color:white;border:none;border-radius:8px;font-size:16px;cursor:pointer;transition:background 0.3s;">Wy≈õlij zg≈Çoszenie</button>
  <button type="reset" style="width:100%;padding:12px;margin-top:10px;background:#f44336;color:white;border:none;border-radius:8px;font-size:16px;cursor:pointer;transition:background 0.3s;">Wyczy≈õƒá formularz</button>

  <!-- Dodanie ukrytego pola URL strony -->
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const urlField = document.createElement("input");
      urlField.type = "hidden";
      urlField.name = "page_url";
      urlField.value = window.location.href;
      document.querySelector("form").appendChild(urlField);
    });
  </script>
</form>
<div style="max-width:1200px;margin:0 auto;padding:40px;font-family:sans-serif;">

  <h1 style="text-align:center;color:#333;margin-bottom:50px;">Zg≈Ço≈õ problem / Kontakt</h1>

  <div style="display:flex;flex-wrap:wrap;gap:40px;justify-content:center;">

    <!-- Formularz dla klient√≥w indywidualnych -->
    <div style="flex:1 1 400px;background:#f9f9f9;padding:30px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.1);">
      <h2 style="text-align:center;color:#4CAF50;margin-bottom:20px;">Dla klient√≥w indywidualnych</h2>
      <p style="text-align:center;color:#555;margin-bottom:25px;">Szybki formularz kontaktowy, je≈õli jeste≈õ klientem prywatnym.</p>

      <!-- Tutaj wklej formularz kontaktowy -->
      <!-- np. kod formularza indywidualnego z poprzedniego kroku -->

    </div>

    <!-- Formularz B2B dla firm -->
    <div style="flex:1 1 400px;background:#f9f9f9;padding:30px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.1);">
      <h2 style="text-align:center;color:#2196F3;margin-bottom:20px;">Dla firm / B2B</h2>
      <p style="text-align:center;color:#555;margin-bottom:25px;">Rozbudowany formularz dla firm, z mo≈ºliwo≈õciƒÖ okre≈õlenia priorytetu i kategorii zg≈Çoszenia.</p>

      <!-- Tutaj wklej formularz B2B -->
      <!-- np. kod formularza B2B z poprzedniego kroku -->

    </div>

  </div>
</div>
MONGO_URI=mongodb+srv://user:pass@cluster.mongodb.net/aitickets
OPENAI_API_KEY=sk-...
PORT=8080
AUTO_RESPONSE=true
SIMILARITY_THRESHOLD=0.78
{
  "name": "aitickets-backend",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "start": "node src/server.js",
    "worker": "node src/worker.js"
  },
  "dependencies": {
    "express": "^4.18.2",
    "mongodb": "^5.8.0",
    "body-parser": "^1.20.2",
    "openai": "^4.9.0",
    "dotenv": "^16.0.0",
    "cors": "^2.8.5",
    "axios": "^1.4.0"
  }
}
import { MongoClient } from "mongodb";
import dotenv from "dotenv";
dotenv.config();

const client = new MongoClient(process.env.MONGO_URI, {});

let db;
export async function connectDB() {
  if (!db) {
    await client.connect();
    db = client.db(process.env.MONGO_DBNAME || "aitickets");
    // ensure indexes
    await db.collection("kb").createIndex({ embedding: "2dsphere" }).catch(()=>{});
    // We'll store embeddings as arrays; for simple cosine search we'll compute in JS
  }
  return db;
}
import OpenAI from "openai";
import dotenv from "dotenv";
dotenv.config();

export const client = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

export async function embedText(text) {
  const resp = await client.embeddings.create({
    model: "text-embedding-3-large",
    input: text
  });
  return resp.data[0].embedding; // float array
}

export async function askAssistant(systemPrompt, messages = []) {
  const resp = await client.chat.completions.create({
    model: "gpt-4o-mini", // dostosuj do dostƒôpno≈õci
    messages: [{ role: "system", content: systemPrompt }, ...messages],
    max_tokens: 512
  });
  return resp.choices[0].message.content;
}
export function dot(a, b) {
  let s = 0;
  for (let i = 0; i < a.length; i++) s += a[i] * b[i];
  return s;
}

export function norm(a) {
  let s = 0;
  for (let i = 0; i < a.length; i++) s += a[i]*a[i];
  return Math.sqrt(s);
}

export function cosineSim(a, b) {
  return dot(a, b) / (norm(a) * norm(b) + 1e-12);
}
import express from "express";
import bodyParser from "body-parser";
import dotenv from "dotenv";
import { connectDB } from "./db.js";
import { embedText, askAssistant } from "./openaiClient.js";
import { cosineSim } from "./utils.js";

dotenv.config();
const app = express();
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));
app.use((req,res,next)=>{ res.setHeader("Access-Control-Allow-Origin","*"); next(); });

const SIM_THRESHOLD = parseFloat(process.env.SIMILARITY_THRESHOLD || "0.78");

// Endpoint kt√≥ry odbiera zg≈Çoszenia (Formsubmit -> webhook) lub bezpo≈õrednio z form
app.post("/api/tickets", async (req, res) => {
  try {
    const db = await connectDB();
    const { company, name, email, phone, subject, message, page_url } = req.body;
    const ticket = {
      company, name, email, phone, subject, message, page_url,
      createdAt: new Date(),
      status: "new"
    };

    // 1) zapisz surowy ticket
    const tRes = await db.collection("tickets").insertOne(ticket);
    ticket._id = tRes.insertedId;

    // 2) stw√≥rz embedding i zapisz
    const textForEmbedding = `${subject}\n${message}`;
    const embedding = await embedText(textForEmbedding);
    await db.collection("ticket_embeddings").insertOne({ ticketId: ticket._id, embedding });

    // 3) similarity search w bazie wiedzy (canonical entries)
    const kbDocs = await db.collection("kb").find({ status: "canonical" }).toArray();
    let best = { score: -1, doc: null };
    for (const doc of kbDocs) {
      const score = cosineSim(embedding, doc.embedding);
      if (score > best.score) { best = { score, doc }; }
    }

    if (best.score >= SIM_THRESHOLD && best.doc) {
      // Mamy dopasowanie ‚Äî automatyczna sugestia
      const suggestedResolution = best.doc.resolution;
      // opcjonalnie wy≈õlij automatycznƒÖ odpowied≈∫ e-mail lub zapisz jako suggested
      await db.collection("tickets").updateOne({ _id: ticket._id }, { $set: { status: "suggested", suggestedResolution, matchedKB: best.doc._id, similarity: best.score } });
      // (Opcjonalnie) tu mo≈ºna wywo≈Çaƒá mailer / webhook do powiadomienia
    } else {
      // Nowy problem ‚Äî zapisz do KB jako kandydat, do weryfikacji
      const kbEntry = {
        title: subject || message.slice(0,60),
        exampleTicketId: ticket._id,
        excerpt: message.slice(0,500),
        createdAt: new Date(),
        status: "candidate", // admin must review
        embedding
      };
      const kRes = await db.collection("kb").insertOne(kbEntry);
      await db.collection("tickets").updateOne({ _id: ticket._id }, { $set: { status: "pending_review", kbCandidateId: kRes.insertedId } });
    }

    res.json({ ok: true, ticketId: ticket._id });

  } catch (err) {
    console.error(err);
    res.status(500).json({ ok:false, error: err.message });
  }
});

// Admin: list candidates
app.get("/api/admin/kb/candidates", async (req,res)=> {
  const db = await connectDB();
  const candidates = await db.collection("kb").find({ status: "candidate" }).toArray();
  res.json(candidates);
});

// Admin: promote candidate -> canonical (accept resolution)
app.post("/api/admin/kb/promote", async (req,res)=>{
  const db = await connectDB();
  const { kbId, resolution } = req.body;
  if (!kbId || !resolution) return res.status(400).json({ error: "kbId and resolution required" });
  await db.collection("kb").updateOne({ _id: new (await import("mongodb")).ObjectId(kbId) }, { $set: { status: "canonical", resolution, promotedAt: new Date() }});
  res.json({ ok:true });
});

const PORT = process.env.PORT || 8080;
app.listen(PORT, ()=> console.log("Server running on", PORT));
import { connectDB } from "./db.js";
import { embedText } from "./openaiClient.js";
import { cosineSim } from "./utils.js";

async function rebuildEmbeddings() {
  const db = await connectDB();
  const tickets = await db.collection("tickets").find({}).toArray();
  for (const t of tickets) {
    const text = `${t.subject}\n${t.message}`;
    const emb = await embedText(text);
    await db.collection("ticket_embeddings").updateOne({ ticketId: t._id }, { $set: { embedding: emb }}, { upsert: true });
  }
  console.log("Rebuilt ticket embeddings");
}

async function detectClusters() {
  // prosty pass: por√≥wnaj tickets z KB i przypisz podobne
  const db = await connectDB();
  const kb = await db.collection("kb").find({ status: "canonical" }).toArray();
  const tickets = await db.collection("tickets").find({ status: { $in: ["new","pending_review"] } }).toArray();

  for (const t of tickets) {
    const embDoc = await db.collection("ticket_embeddings").findOne({ ticketId: t._id });
    if (!embDoc) continue;
    let best = { score: -1, doc: null };
    for (const k of kb) {
      const score = cosineSim(embDoc.embedding, k.embedding);
      if (score > best.score) best = { score, doc: k };
    }
    if (best.score > parseFloat(process.env.SIMILARITY_THRESHOLD || "0.78")) {
      await db.collection("tickets").updateOne({ _id: t._id }, { $set: { status: "suggested", matchedKB: best.doc._id, similarity: best.score }});
    }
  }
  console.log("Cluster detection pass done");
}

(async ()=> {
  await rebuildEmbeddings();
  await detectClusters();
  process.exit(0);
})();
<!doctype html>
<html>
<body>
  <h1>KB Candidates</h1>
  <div id="list"></div>
  <script>
    async function load() {
      const r = await fetch("/api/admin/kb/candidates");
      const items = await r.json();
      const container = document.getElementById("list");
      container.innerHTML = "";
      items.forEach(it=>{
        const d = document.createElement("div");
        d.innerHTML = `<h3>${it.title}</h3><p>${it.excerpt}</p>
          <textarea id="res-${it._id}"></textarea>
          <button onclick="promote('${it._id}')">Promote</button>`;
        container.appendChild(d);
      });
    }
    async function promote(id) {
      const res = document.getElementById("res-"+id).value;
      await fetch("/api/admin/kb/promote", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ kbId:id, resolution: res })});
      alert("Promoted");
      load();
    }
    load();
  </script>
</body>
</html>
